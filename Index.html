<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>احسب عمرك</title><meta name="description" content="احسب عمرك الدقيق مع عدادات مباشرة، عيد الميلاد القادم، الأبراج، التاريخ الهجري والمزيد. واجهة عربية بالكامل ودعم الثيم وتصدير PDF."><link rel="canonical" href="https://example.com/age-insights"><meta property="og:type" content="website"><meta property="og:title" content="احسب عمرك"><meta property="og:description" content="حساب عمر دقيق، العد التنازلي، الأبراج، التاريخ الهجري. يدعم العربية والاتجاه من اليمين."><meta property="og:url" content="https://example.com/age-insights"><meta property="og:image" content="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1200' height='630'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='%237c3aed'/><stop offset='1' stop-color='%231e40af'/></linearGradient></defs><rect width='100%25' height='100%25' fill='url(%23g)'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='Segoe UI, Arial' font-size='64' fill='white'>Age &amp; Insights</text></svg>"><link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop stop-color='%237c3aed'/%3E%3Cstop offset='1' stop-color='%231e40af'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='64' height='64' rx='12' fill='url(%23g)'/%3E%3Cpath d='M18 34a14 14 0 1128 0 14 14 0 01-28 0zm14-10a10 10 0 100 20 10 10 0 000-20zm0 4a2 2 0 012 2v6l4 2a2 2 0 11-2 3.464L30 38.535V30a2 2 0 012-2z' fill='%23fff'/%3E%3C/svg%3E"><script type="application/ld+json">{"@context":"https://schema.org","@type":"WebSite","name":"Age & Insights","url":"https://example.com/age-insights","inLanguage":"ar"}</script><style>
:root{
  --bg:#0b1220; --fg:#e6e9ef; --muted:#a7b0c3; --card:#0f172a; --border:#1f2937;
  --accent:#7c3aed; --accent-2:#1e40af; --ok:#16a34a; --warn:#d97706; --err:#ef4444;
  --shadow:0 10px 30px rgba(0,0,0,.45), 0 2px 6px rgba(0,0,0,.3);
  --radius:14px; --radius-sm:10px;
  --space-1:.5rem; --space-2:.8rem; --space-3:1.1rem; --space-4:1.35rem; --space-5:1.8rem;
  --field-pad:.85rem 1rem;
  --focus:3px solid color-mix(in oklab, var(--accent) 60%, transparent);
  --font: "Segoe UI", "Noto Naskh Arabic", "Noto Sans Arabic", Tahoma, Arial, system-ui, -apple-system, "Apple Color Emoji", "Segoe UI Emoji";
}
@media (prefers-color-scheme: light){
  :root{ --bg:#ffffff; --fg:#0f172a; --muted:#64748b; --card:#f8fafc; --border:#e2e8f0; --shadow:0 10px 30px rgba(0,0,0,.08), 0 2px 6px rgba(0,0,0,.04); }
}
[data-theme="light"]{ --bg:#ffffff; --fg:#0f172a; --muted:#64748b; --card:#f8fafc; --border:#e2e8f0; --shadow:0 10px 30px rgba(0,0,0,.08), 0 2px 6px rgba(0,0,0,.04); }
[data-theme="dark"]{ --bg:#0b1220; --fg:#e6e9ef; --muted:#a7b0c3; --card:#0f172a; --border:#1f2937; --shadow:0 10px 30px rgba(0,0,0,.45), 0 2px 6px rgba(0,0,0,.3); }

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family:var(--font); color:var(--fg); line-height:1.6;
  background:
    radial-gradient(1200px 1200px at 10% -10%, color-mix(in oklab, var(--accent) 24%, transparent), transparent 60%),
    radial-gradient(1200px 1200px at 110% 10%, color-mix(in oklab, var(--accent-2) 24%, transparent), transparent 60%),
    linear-gradient(135deg, color-mix(in oklab, var(--accent) 22%, transparent), color-mix(in oklab, var(--accent-2) 22%, transparent)),
    var(--bg);
  background-attachment: fixed;
}
a{color:color-mix(in oklab, var(--accent) 70%, #fff 30%); text-decoration:none}
a:hover{text-decoration:underline}
.container{max-width:1100px; margin-inline:auto; padding-inline:clamp(1rem,4vw,2rem)}
.header{
  position:sticky; top:0; z-index:20; backdrop-filter:saturate(140%) blur(8px);
  background: color-mix(in oklab, var(--bg) 78%, transparent); border-block-end:1px solid var(--border);
}
.brand{display:flex; align-items:center; gap:.9rem; padding-block:1rem}
.brand .logo{inline-size:40px; block-size:40px; border-radius:12px; display:grid; place-items:center; background:linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow:var(--shadow)}
.brand .logo svg{inline-size:24px; block-size:24px; filter:drop-shadow(0 2px 3px rgba(0,0,0,.2))}
.controls{display:flex; gap:.6rem; margin-inline-start:auto; align-items:center; flex-wrap:wrap}
button, select, input, .chip{
  font:inherit; color:inherit; background:var(--card); border:1px solid var(--border); padding:var(--field-pad);
  border-radius:999px;
}
input[type="date"], input[type="time"], select{inline-size:100%}
.chip{display:inline-flex; align-items:center; gap:.5rem}
.btn{
  background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#fff; border:0; padding:.9rem 1.25rem; border-radius:999px; box-shadow:var(--shadow);
}
.btn.secondary{background:transparent; color:var(--accent); border:1px solid color-mix(in oklab, var(--accent) 70%, var(--border))}
.btn.ghost{background:transparent; border:1px dashed var(--border)}
.btn:disabled{opacity:.6; cursor:not-allowed}
.icon{inline-size:1.1rem; block-size:1.1rem}
input, select, button{transition: background-color .2s, border-color .2s, transform .06s}
@media (prefers-reduced-motion: reduce){*{transition:none!important; animation:none!important}}
input:focus, select:focus, button:focus{outline:var(--focus); outline-offset:2px}
input:hover, select:hover{border-color:color-mix(in oklab, var(--accent) 50%, var(--border))}
small.note{color:var(--muted)}
hr.sep{border:0; border-block-start:1px dashed var(--border); margin-block:1.2rem}

/* Layout */
.main{padding-block: clamp(1rem, 6vw, 2rem)}
.grid{display:grid; gap:clamp(1.2rem, 3vw, 1.7rem); grid-template-columns:1fr}
@media (min-width: 900px){ .grid{ grid-template-columns: 410px 1fr } }
.card{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
  padding:clamp(1.2rem, 3.2vw, 1.5rem); position:relative; overflow:hidden;
}
.card::before{
  content:""; position:absolute; inset-inline:0; inset-block-start:0; block-size:4px;
  background:linear-gradient(90deg, var(--accent), var(--accent-2));
}
h1{font-size: clamp(1.2rem, 2.5vw, 1.8rem); margin:0}
h2{font-size: clamp(1.05rem, 2vw, 1.25rem); margin:.2rem 0 1rem}
h3{font-size:1rem; margin:0 0 .6rem}
.section-title{display:flex; align-items:center; gap:.7rem; margin-block-end:1rem}
.form fieldset{border:0; margin:0; padding:0; display:grid; gap:1.15rem}
.group{display:grid; gap:.45rem}
.label{display:flex; align-items:center; justify-content:space-between; gap:.6rem; font-weight:700}
.helper{color:var(--muted); font-weight:400; font-size:.92em}
.row{display:grid; gap:1.15rem; grid-template-columns:1fr}
@media (min-width:560px){ .row.two{ grid-template-columns:1fr 1fr } }
.actions{display:flex; flex-wrap:wrap; gap:.8rem; margin-block-start:.4rem}

.kpis{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:1rem}
@media (min-width:720px){.kpis{grid-template-columns: repeat(4, minmax(0,1fr))}}
.kpi{padding:1rem; background:linear-gradient(180deg, color-mix(in oklab, var(--card) 92%, transparent), var(--card)); border:1px solid var(--border); border-radius:var(--radius-sm)}
.kpi .value{font-weight:800; font-size:clamp(1.2rem, 3vw, 1.6rem)}
.kpi .label{color:var(--muted); font-size:.9rem}

.grid-cols{display:grid; gap:1.2rem; grid-template-columns:1fr}
@media (min-width:760px){.grid-cols{grid-template-columns: repeat(2, minmax(0,1fr))}}
.list{display:grid; gap:.65rem}
.item{display:flex; align-items:flex-start; gap:.85rem; padding:.6rem .4rem; border-radius:10px}
.item:hover{background-color:color-mix(in oklab, var(--card) 78%, transparent)}
.badge{display:inline-block; padding:.3rem .65rem; border-radius:999px; background:linear-gradient(135deg, color-mix(in oklab, var(--accent) 18%, transparent), color-mix(in oklab, var(--accent-2) 18%, transparent)); color:#fff; font-weight:700; font-size:.8rem; border:1px solid color-mix(in oklab, var(--accent) 40%, transparent)}

.results[hidden]{display:none!important}
[aria-live="polite"]{min-block-size:1.25rem}

footer{padding-block:1rem; border-block-start:1px solid var(--border); color:var(--muted)}
footer .footer-grid{display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap}

@media print{
  .header, .controls, .note-storage, #langToggle, #themeToggle{display:none!important}
  body{background:#fff; color:#111827}
  .card{box-shadow:none; border-color:#e5e7eb}
}

/* RTL helpers */
.dir-rtl .brand{flex-direction:row-reverse}
.dir-rtl .controls{margin-inline-start:0; margin-inline-end:auto}
.dir-rtl .item{flex-direction:row-reverse}
.dir-rtl select, .dir-rtl input, .dir-rtl button{text-align:start}
</style></head><body class="dir-rtl">
<header class="header">
  <div class="container" style="display:flex; align-items:center; gap:.75rem">
    <div class="brand" aria-label="Brand">
      <div class="logo" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3a9 9 0 100 18 9 9 0 000-18Zm0 4a1 1 0 011 1v5.2l3.2 1.85a1 1 0 11-1 1.73l-3.7-2.14A1 1 0 0111 14V8a1 1 0 011-1Z" fill="#fff"/></svg></div>
      <div>
        <h1></h1> احسب عمرك </h1>
        <small class="note">تحليلات دقيقة لتاريخ الميلاد</small>
      </div>
    </div>
    <div class="controls" role="group" aria-label="تبديل">
    
      <button class="chip" id="themeToggle" type="button" aria-pressed="false" title="النمط">
        <span class="icon" aria-hidden="true">🌓</span><span id="themeLabel">داكن</span>
      </button>
    </div>
  </div>
</header>

<main class="main container">
  <div class="grid">
    <section class="card form" aria-labelledby="formTitle">
      <div class="section-title">
        <h2 id="formTitle">بياناتك</h2>
        <span class="badge" id="tzBadge">UTC</span>
      </div>
      <form id="dobForm" novalidate>
        <fieldset>
          <div class="group">
            <label class="label" for="dob"><span>تاريخ الميلاد</span><span class="helper">إلزامي</span></label>
            <input id="dob" name="dob" type="date" required aria-required="true" autocomplete="bday" />
            <div id="dobError" role="alert" class="helper" style="color:var(--err)"></div>
          </div>

          <div class="row two">
            <div class="group">
              <label class="label" for="tob"><span>وقت الميلاد</span><span class="helper">اختياري</span></label>
              <input id="tob" name="tob" type="time" step="60" autocomplete="bday-time" />
            </div>
            <div class="group">
              <label class="label" for="tz"><span>المنطقة الزمنية</span><span class="helper">تلقائي</span></label>
              <select id="tz" name="tz" aria-describedby="tzBadge"></select>
            </div>
          </div>

          <div class="group">
            <label class="label" for="hemisphere"><span>نصف الكرة</span><span class="helper">لتحديد فصل الميلاد</span></label>
            <select id="hemisphere" name="hemisphere">
              <option value="N">الشمالي</option>
              <option value="S">الجنوبي</option>
              <option value="A" selected>تلقائي (الشمالي)</option>
            </select>
          </div>

          <div class="actions" role="group" aria-label="إجراءات">
            <button class="btn" id="calcBtn" type="submit">احسب</button>
            <button class="btn secondary" id="resetBtn" type="reset">إعادة ضبط</button>
            <button class="btn secondary" id="pdfBtn" style="color:#7c3aed" type="button">تحميل PDF</button>

          </div>
          <hr class="sep" aria-hidden="true">
          <small class="note note-storage">التفضيلات (اللغة، النمط، نصف الكرة) محفوظة على جهازك فقط.</small>
        </fieldset>
      </form>
    </section>

    <section class="card results" id="results" hidden aria-live="polite">
      <div class="section-title"><h2>نتائجك</h2></div>

      <div class="kpis" role="list">
        <div class="kpi" role="listitem"><div class="value" id="ageExact">—</div><div class="label">العمر الدقيق</div></div>
        <div class="kpi" role="listitem"><div class="value" id="nextAge">—</div><div class="label">العمر في عيد الميلاد القادم</div></div>
        <div class="kpi" role="listitem"><div class="value" id="bornWeekday">—</div><div class="label">وُلدت في</div></div>
        <div class="kpi" role="listitem"><div class="value" id="season">—</div><div class="label">فصل الميلاد</div></div>
      </div>

      <hr class="sep" aria-hidden="true">

      <div class="grid-cols">
        <div class="card" style="padding:1rem">
          <h3>عدادات مباشرة</h3>
          <div class="list">
            <div class="item"><span class="badge">الأيام</span><span id="totalDays">—</span></div>
            <div class="item"><span class="badge">الساعات</span><span id="totalHours">—</span></div>
            <div class="item"><span class="badge">الدقائق</span><span id="totalMinutes">—</span></div>
            <div class="item"><span class="badge">الثواني</span><span id="totalSeconds">—</span></div>
          </div>
        </div>
        <div class="card" style="padding:1rem">
          <h3>عيد الميلاد القادم</h3>
          <div class="list">
            <div class="item"><span class="badge">التاريخ</span><span id="nextBdayDate">—</span></div>
            <div class="item"><span class="badge">العد التنازلي</span><span id="bdayCountdown">—</span></div>
            <div class="item"><span class="badge">الأسبوع ISO</span><span id="isoWeek">—</span></div>
          </div>
        </div>
      </div>

      <div class="grid-cols" style="margin-block-start:1rem">
        <div class="card" style="padding:1rem">
          <h3>تفاصيل يوم الميلاد</h3>
          <div class="list">
            <div class="item"><span class="badge">اليوم من السنة</span><span id="dayOfYear">—</span></div>
            <div class="item"><span class="badge">سنة كبيسة</span><span id="leapYear">—</span></div>
            <div class="item"><span class="badge">ملاحظة 29 فبراير</span><span id="feb29Note">—</span></div>
          </div>
        </div>
        <div class="card" style="padding:1rem">
          <h3>الأبراج وحقائق ممتعة</h3>
          <div class="list">
            <div class="item"><span class="badge">الغربي</span><span id="westernZodiac">—</span></div>
            <div class="item"><span class="badge">الصيني</span><span id="chineseZodiac">—</span></div>
            <div class="item"><span class="badge">حجر المولد</span><span id="birthstone">—</span></div>
          </div>
        </div>
      </div>

      <div class="card" style="padding:1rem; margin-block-start:1rem">
        <h3>تحويلات التقويم</h3>
        <div class="list">
          <div class="item"><span class="badge">الهجري (الميلاد)</span><span id="hijriBirth">—</span></div>
          <div class="item"><span class="badge">الهجري (العيد القادم)</span><span id="hijriNext">—</span></div>
          <div class="item"><span class="badge">الدعم</span><span id="hijriSupport">—</span></div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="copyBtn" type="button">نسخ النتائج</button>
        <span id="copyStatus" class="helper" aria-live="polite"></span>
      </div>
    </section>
  </div>
</main>

<footer class="container">
  <div class="footer-grid">
    <div><small>&copy; <span id="yearNow"></span> Mohammed Shukri</small></div>
    <div><small class="note">لخصوصيتك، تبقى بياناتك داخل المتصفح. اعرف المزيد: </small></div>
  </div>
</footer>

<script>
(() => {
  "use strict";
  // عناصر DOM
  const $ = (id)=>document.getElementById(id);
  const E = { form:$("dobForm"), dob:$("dob"), tob:$("tob"), tz:$("tz"), tzBadge:$("tzBadge"),
    hemi:$("hemisphere"), results:$("results"),
    ageExact:$("ageExact"), nextAge:$("nextAge"), bornWeekday:$("bornWeekday"), season:$("season"),
    totalDays:$("totalDays"), totalHours:$("totalHours"), totalMinutes:$("totalMinutes"), totalSeconds:$("totalSeconds"),
    nextBdayDate:$("nextBdayDate"), bdayCountdown:$("bdayCountdown"), isoWeek:$("isoWeek"),
    dayOfYear:$("dayOfYear"), leapYear:$("leapYear"), feb29Note:$("feb29Note"),
    westernZodiac:$("westernZodiac"), chineseZodiac:$("chineseZodiac"), birthstone:$("birthstone"),
    hijriBirth:$("hijriBirth"), hijriNext:$("hijriNext"), hijriSupport:$("hijriSupport"),
    copy:$("copyBtn"), copyStatus:$("copyStatus"), reset:$("resetBtn"), pdf:$("pdfBtn"), dobError:$("dobError"),
    themeToggle:$("themeToggle"), themeLabel:$("themeLabel"), langToggle:$("langToggle"), langLabel:$("langLabel"),
    yearNow:$("yearNow")
  };
  E.yearNow.textContent = new Date().getFullYear();

  // حالة
  const state = {
    lang: "ar",
    theme: localStorage.getItem("ai.theme") || "dark",
    hemi: localStorage.getItem("ai.hemi") || "A",
    tz: Intl.DateTimeFormat().resolvedOptions().timeZone || "UTC",
    birthUTC:null, nextUTC:null, tick:null
  };

  // أدوات
  const nf = (o={})=> new Intl.NumberFormat(state.lang, o);
  const setText = (el, s)=>{ if(el) el.textContent = s; };
  const isLeap = y => (y%4===0 && y%100!==0) || (y%400===0);
  const daysInMonth = (y,m)=> [31,isLeap(y)?29:28,31,30,31,30,31,31,30,31,30,31][m-1];
  const dayOfYearFrom = (y,m,d)=> { let n=d; for(let i=1;i<m;i++) n+=daysInMonth(y,i); return n; };
  function isoWeekNumber(y,m,d){
    const dt = new Date(Date.UTC(y,m-1,d));
    const day = (dt.getUTCDay()+6)%7+1;
    dt.setUTCDate(dt.getUTCDate() + (4 - day));
    const start = new Date(Date.UTC(dt.getUTCFullYear(),0,1));
    return Math.floor((((dt - start)/86400000)+1)/7)+1;
  }
  function diffYMD(b, n){
    let y=n.year-b.year, m=n.month-b.month, d=n.day-b.day;
    if(d<0){ m--; d+=daysInMonth(n.year, ((n.month+10)%12)+1); }
    if(m<0){ y--; m+=12; }
    return {y,m,d};
  }
  function seasonOf(month, hemi){
    const north = month>=3&&month<=5?"الربيع":month>=6&&month<=8?"الصيف":month>=9&&month<=11?"الخريف":"الشتاء";
    if (hemi==="S") return ({الربيع:"الخريف",الصيف:"الشتاء",الخريف:"الربيع",الشتاء:"الصيف"})[north];
    return north;
  }
  function westernZodiac(m,d){
    const z=[["الجدي",1,19],["الدلو",2,18],["الحوت",3,20],["الحمل",4,19],["الثور",5,20],["الجوزاء",6,20],["السرطان",7,22],["الأسد",8,22],["العذراء",9,22],["الميزان",10,22],["العقرب",11,21],["القوس",12,21],["الجدي",12,31]];
    for(const [name,mm,dd] of z){ if(m<mm || (m===mm && d<=dd)) return name; }
    return "الجدي";
  }
  
  function chineseZodiac(y){ const animals=["الفأر","الثور","النمر","الأرنب","التنين","الثعبان","الحصان","الخروف","القرد","الديك","الكلب","الخنزير"]; return animals[(y-2020)%12<0? (12+((y-2020)%12))%12 : (y-2020)%12]; }
  const stones = ["العقيق","الجمشت","الأكوامارين","الماس","الزمرد","اللؤلؤ/إسكندريت","الياقوت","البريدوت/السبينل","اليَاقوت الأزرق","الأوبال/التورمالين","التوباز/السترين","الفيروز/الزركون/التنزانايت"];
  const fmtZoned = (date, tz, opts)=> new Intl.DateTimeFormat(state.lang, {timeZone:tz, ...opts}).format(date);
  function tzOffsetMinutes(date, tz){
    try{
      const str = new Intl.DateTimeFormat("en-US",{timeZone:tz,timeZoneName:"shortOffset",hour:"2-digit"}).format(date);
      const m = str.match(/GMT([+-]\d{1,2})(?::?(\d{2}))?/);
      if(m){ const h=+m[1], mm=+(m[2]||0); return -(h*60 + (h<0?-mm:mm)); }
    }catch{}
    return date.getTimezoneOffset();
  }
  function zonedToUTC(y,m,d,H=0,Mi=0,tz){
    const guess = Date.UTC(y,m-1,d,H,Mi,0);
    const off = tzOffsetMinutes(new Date(guess), tz);
    return guess - off*60*1000;
  }

  // تعبئة المناطق الزمنية (قائمة مختصرة، تعمل أوفلاين)
  const TZ_LIST = ["UTC","Asia/Baghdad","Asia/Riyadh","Asia/Dubai","Europe/London","Europe/Paris","Africa/Cairo","Africa/Tripoli","Asia/Tehran","Asia/Kolkata","Asia/Tokyo","Asia/Shanghai","Australia/Sydney","America/New_York","America/Los_Angeles","America/Sao_Paulo"];
  function populateTZ(){
    const current = state.tz;
    E.tz.innerHTML = "";
    TZ_LIST.sort().forEach(z=>{
      const opt=document.createElement("option");
      opt.value=z;
      let abbr=""; try{ abbr=new Intl.DateTimeFormat("en-US",{timeZone:z,timeZoneName:"short"}).format(new Date()).split(" ").pop(); }catch{}
      opt.textContent = z + (abbr?` (${abbr})`:"");
      if(z===current) opt.selected=true;
      E.tz.appendChild(opt);
    });
    E.tzBadge.textContent = current;
  }

  // هِجري
  let hijriFmt=null, hijriOK=false;
  function setupHijri(){
    hijriOK = true;
    try{
      hijriFmt = new Intl.DateTimeFormat("ar-u-ca-islamic", {calendar:"islamic", year:"numeric", month:"long", day:"numeric"});
    }catch{ hijriOK = false; }
  }

  // عرض النتائج
  function renderAll(){
    const tz = state.tz;
    const birth = state.birthUTC; if(!birth) return;
    const now = Date.now();
    const birthDate = new Date(birth);

    const np = new Intl.DateTimeFormat("en-US",{timeZone:tz,year:"numeric",month:"numeric",day:"numeric"}).formatToParts(now).reduce((o,p)=>{if(p.type!=="literal")o[p.type]=+p.value;return o;},{});
    const bp = new Intl.DateTimeFormat("en-US",{timeZone:tz,year:"numeric",month:"numeric",day:"numeric",weekday:"long"}).formatToParts(birthDate).reduce((o,p)=>{if(p.type!=="literal")o[p.type]=p.value;return o;},{});
    const b={year:+bp.year, month:+bp.month, day:+bp.day};
    const n={year:+np.year, month:+np.month, day:+np.day};

   const ymd = diffYMD(b,n);

// نجعل النص يحتوي على أسطر جديدة
setText(
  E.ageExact,
  `${nf().format(ymd.y)} سنة\n${nf().format(ymd.m)} شهر\n${nf().format(ymd.d)} يوم`
);

// تصغير الخط
E.ageExact.style.fontSize = "1.5rem";

// ضبط العنصر ليعرض الأسطر الجديدة
E.ageExact.style.whiteSpace = "pre-line";

setText(E.bornWeekday, fmtZoned(birthDate, tz, {weekday:"long"}));
E.bornWeekday.style.fontSize = "1.5rem";

const hemi = state.hemi==="A" ? "N" : state.hemi;
setText(E.season, seasonOf(b.month, hemi));
E.season.style.fontSize = "1.5rem";




    
    const elapsed = now - birth;
    const totalSec = Math.floor(elapsed/1000);
    setText(E.totalSeconds, nf().format(totalSec));
    setText(E.totalMinutes, nf().format(Math.floor(totalSec/60)));
    setText(E.totalHours, nf().format(Math.floor(totalSec/3600)));
    setText(E.totalDays, nf().format(Math.floor(totalSec/86400)));

    setText(E.dayOfYear, nf().format(dayOfYearFrom(b.year,b.month,b.day)));
    setText(E.isoWeek, nf().format(isoWeekNumber(b.year,b.month,b.day)));
    setText(E.leapYear, isLeap(b.year) ? "نعم" : "لا");

    if (b.month===2 && b.day===29){
      let y = n.year;
      while(!isLeap(y) || (n.month>2 || (n.month===2 && n.day>29))) y++;
      setText(E.feb29Note, "أقرب 29 فبراير فعلي: " + fmtZoned(new Date(Date.UTC(y,1,29)), tz, {year:"numeric",month:"long",day:"numeric",weekday:"long"}));
    } else setText(E.feb29Note, "—");

    let nextY = n.year;
    if (n.month > b.month || (n.month===b.month && n.day >= b.day)) nextY++;
    const nextDate = new Date(Date.UTC(nextY, b.month-1, Math.min(b.day, daysInMonth(nextY,b.month))));
    state.nextUTC = nextDate.getTime();
    setText(E.nextAge, nf().format(ymd.y + (n.month > b.month || (n.month === b.month && n.day >= b.day) ? 1 : 0)));
    setText(E.nextBdayDate, fmtZoned(nextDate, tz, {year:"numeric", month:"long", day:"numeric", weekday:"long"}));

    const wz = westernZodiac(b.month, b.day);
    setText(E.westernZodiac, wz);
    const cz = chineseZodiac(b.year);
    setText(E.chineseZodiac, cz);
    setText(E.birthstone, stones[b.month-1]);

    if (!hijriFmt) setupHijri();
    if (hijriOK) {
      setText(E.hijriBirth, hijriFmt.format(birthDate));
      setText(E.hijriNext, hijriFmt.format(nextDate));
      setText(E.hijriSupport, "نعم");
    } else {
      setText(E.hijriBirth, "غير مدعوم على هذا الجهاز");
      setText(E.hijriNext, "غير مدعوم على هذا الجهاز");
      setText(E.hijriSupport, "لا");
    }

    startTick();
  }

  function startTick(){
    if (state.tick) clearInterval(state.tick);
    state.tick = setInterval(()=>{
      if (!state.birthUTC || !state.nextUTC) return;
      const now = Date.now();
      const elapsed = now - state.birthUTC;
      const totalSec = Math.floor(elapsed/1000);
      setText(E.totalSeconds, nf().format(totalSec));
      setText(E.totalMinutes, nf().format(Math.floor(totalSec/60)));
      setText(E.totalHours, nf().format(Math.floor(totalSec/3600)));
      setText(E.totalDays, nf().format(Math.floor(totalSec/86400)));

      let diff = Math.max(0, state.nextUTC - now);
      const d = Math.floor(diff/86400000); diff -= d*86400000;
      const h = Math.floor(diff/3600000); diff -= h*3600000;
      const m = Math.floor(diff/60000); diff -= m*60000;
      const s = Math.floor(diff/1000);
      setText(E.bdayCountdown, `${nf().format(d)} يوم، ${nf().format(h)} ساعة، ${nf().format(m)} دقيقة، ${nf().format(s)} ثانية`);
    }, 1000);
  }

  // تحقق واحتساب
  function validate(){
    E.dobError.textContent = "";
    if (!E.dob.value){ E.dobError.textContent = "يرجى إدخال تاريخ ميلاد صالح."; return false; }
    const [y,m,d] = E.dob.value.split("-").map(Number);
    const dobDate = new Date(y, m-1, d);
    if (dobDate > new Date()){ E.dobError.textContent = "لا يمكن أن يكون التاريخ في المستقبل."; return false; }
    return true;
  }
  function compute(){
    if (!validate()) return;
    const [y,m,d] = E.dob.value.split("-").map(Number);
    const [H,Mi] = (E.tob.value || "00:00").split(":").map(Number);
    state.birthUTC = zonedToUTC(y,m,d,H||0,Mi||0,state.tz);
    E.results.hidden = false;
    renderAll();
  }

  // نسخ النتائج
  function copyResults(){
    if (!state.birthUTC) return;
    const text = [
      `العمر الدقيق: ${E.ageExact.textContent}`,
      `وُلدت في: ${E.bornWeekday.textContent}`,
      `فصل الميلاد: ${E.season.textContent}`,
      `عيد الميلاد القادم: ${E.nextBdayDate.textContent}`,
      `العد التنازلي: ${E.bdayCountdown.textContent}`,
      `اليوم من السنة: ${E.dayOfYear.textContent} — الأسبوع ISO: ${E.isoWeek.textContent} — سنة كبيسة: ${E.leapYear.textContent}`,
      `البرج الغربي: ${E.westernZodiac.textContent}`,
      `البرج الصيني: ${E.chineseZodiac.textContent}`,
      `حجر المولد: ${E.birthstone.textContent}`,
      `الهجري (الميلاد): ${E.hijriBirth.textContent}`,
      `الهجري (العيد القادم): ${E.hijriNext.textContent}`
    ].join("\n");
    navigator.clipboard.writeText(text).then(()=>E.copyStatus.textContent="تم النسخ!").catch(()=>E.copyStatus.textContent="فشل النسخ");
  }

  // PDF
  function downloadPDF(){
    if (E.results.hidden){ alert("احسب أولاً لعرض النتائج."); return; }
    const win = window.open("", "_blank");
    const css = "body{font-family:Segoe UI,Tahoma,Arial;white-space:pre-wrap;line-height:1.6;padding:24px} h1{font-size:20px} .muted{color:#555}";
    const content = [
      `العمر الدقيق: ${E.ageExact.textContent}`,
      `وُلدت في: ${E.bornWeekday.textContent}`,
      `فصل الميلاد: ${E.season.textContent}`,
      `عيد الميلاد القادم: ${E.nextBdayDate.textContent} (${E.nextAge.textContent})`,
      `العد التنازلي: ${E.bdayCountdown.textContent}`,
      `اليوم من السنة: ${E.dayOfYear.textContent} — الأسبوع ISO: ${E.isoWeek.textContent} — سنة كبيسة: ${E.leapYear.textContent}`,
      `البرج الغربي: ${E.westernZodiac.textContent}`,
      `البرج الصيني: ${E.chineseZodiac.textContent}`,
      `حجر المولد: ${E.birthstone.textContent}`,
      `الهجري (الميلاد): ${E.hijriBirth.textContent}`,
      `الهجري (العيد القادم): ${E.hijriNext.textContent}`
    ].join("<br>");
    win.document.write(`<html><head><meta charset="utf-8"><title>ملخص العمر</title><style>${css}</style></head><body><h1>ملخص العمر</h1>${content}<p class="muted">تم الإنشاء من صفحة احسب عمرك.</p></body></html>`);
    win.document.close();
    win.focus();
    win.print(); // يفتح طباعة → اختر "Save as PDF"
  }

  // أحداث
  E.form.addEventListener("submit", e=>{ e.preventDefault(); compute(); });
  ["input","change"].forEach(evt=>{
    E.dob.addEventListener(evt, ()=>{ if(E.dob.value) compute(); });
    E.tob.addEventListener(evt, ()=>{ if(E.dob.value) compute(); });
  });
  E.reset.addEventListener("click", ()=>{ if(state.tick) clearInterval(state.tick); E.results.hidden = true; E.dobError.textContent=""; });
  E.tz.addEventListener("change", ()=>{ state.tz = E.tz.value; E.tzBadge.textContent = state.tz; if(state.birthUTC) renderAll(); });
  E.hemi.addEventListener("change", ()=>{ state.hemi = E.hemi.value; localStorage.setItem("ai.hemi", state.hemi); if(state.birthUTC) renderAll(); });
  E.copy.addEventListener("click", copyResults);
  E.pdf.addEventListener("click", downloadPDF);


  // الثيم
E.themeToggle.addEventListener("click", ()=>{
  state.theme = state.theme==="dark" ? "light" : "dark";
  localStorage.setItem("ai.theme", state.theme); // حفظ الاختيار
  document.documentElement.setAttribute("data-theme", state.theme);
  E.themeLabel.textContent = state.theme==="dark" ? "داكن" : "فاتح";
});

  // تهيئة
  populateTZ();
  E.hemi.value = state.hemi;
  
  // تهيئة الثيم
  document.documentElement.setAttribute("data-theme", state.theme);
  E.themeLabel.textContent = state.theme==="dark" ? "داكن" : "فاتح";
})();
</script>
</body></html>